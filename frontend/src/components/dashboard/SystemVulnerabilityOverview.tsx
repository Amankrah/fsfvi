'use client';

import React from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { 
  Target, 
  AlertTriangle, 
  TrendingUp,
  RefreshCw,
  Activity,
  DollarSign,
  Shield,
  Gauge,
  BarChart3
} from 'lucide-react';

interface FSFVIResults {
  fsfvi_score: number;
  vulnerability_percent: number;
  risk_level: string;
  financing_efficiency_percent: number;
}

interface FinancialContext {
  total_budget_millions: number;
  budget_efficiency: string;
  optimization_potential: string;
  intervention_urgency: string;
}

interface SystemAnalysis {
  fsfvi_score: number;
  risk_level: string;
  total_allocation_millions: number;
  component_statistics?: {
    weighted_average_vulnerability: number;
    max_vulnerability: number;
    min_vulnerability: number;
    vulnerability_range?: number;
    total_components?: number;
  };
  government_insights?: {
    financing_efficiency_percent: number;
    resource_allocation_quality: string;
    budget_optimization_potential: string;
    intervention_urgency: string;
    system_stability: string;
  };
  critical_components?: string[];
  high_priority_components?: string[];
}

interface SystemVulnerabilityData {
  fsfvi_results?: FSFVIResults;
  financial_context?: FinancialContext;
  system_analysis?: SystemAnalysis;
  mathematical_interpretation?: {
    score: number;
    vulnerability_percent: number;
    interpretation: string;
    performance_category?: string;
    formula_applied?: string;
  };
  executive_summary?: {
    overall_assessment: string;
    key_metrics: {
      fsfvi_score: string;
      financing_efficiency: string;
      critical_components: number;
      total_budget: string;
    };
    immediate_actions_required: boolean;
    system_stability: string;
  };
  analysis_metadata?: {
    total_components: number;
    total_budget_millions: number;
    method_used: string;
    scenario: string;
    timestamp: string;
    advanced_weighting_used: boolean;
    sensitivity_estimation_method: string;
  };
  country?: string;
  fiscal_year?: number;
  currency?: string;
  weighting_method?: string;
  scenario?: string;
}

interface SystemVulnerabilityOverviewProps {
  data: SystemVulnerabilityData | null;
  onRefresh: () => Promise<void>;
}

export const SystemVulnerabilityOverview: React.FC<SystemVulnerabilityOverviewProps> = ({ 
  data, 
  onRefresh 
}) => {
  const getRiskColor = (riskLevel: string) => {
    switch (riskLevel?.toLowerCase()) {
      case 'low':
        return 'text-green-600 bg-green-100 border-green-200';
      case 'medium':
        return 'text-yellow-600 bg-yellow-100 border-yellow-200';
      case 'high':
        return 'text-orange-600 bg-orange-100 border-orange-200';
      case 'critical':
        return 'text-red-600 bg-red-100 border-red-200';
      default:
        return 'text-gray-600 bg-gray-100 border-gray-200';
    }
  };

  const getVulnerabilityGaugeColor = (score: number) => {
    if (score < 0.1) return 'text-green-600';
    if (score < 0.2) return 'text-yellow-600';
    if (score < 0.4) return 'text-orange-600';
    return 'text-red-600';
  };

  if (!data) {
    return (
      <div className="space-y-6">
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center">
              <Target className="w-5 h-5 mr-2" />
              System FSFVI Analysis
            </CardTitle>
            <CardDescription>
              System vulnerability analysis has not been calculated yet.
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="text-center py-8">
              <Target className="h-12 w-12 text-gray-400 mx-auto mb-4" />
              <h3 className="text-lg font-medium text-gray-900 mb-2">
                No System Analysis Data
              </h3>
              <p className="text-gray-600 mb-4">
                Run the system vulnerability analysis to see the overall FSFVI score and insights.
              </p>
              <Button onClick={onRefresh}>
                <TrendingUp className="w-4 h-4 mr-2" />
                Calculate System FSFVI
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Extract data from structured response - match ComponentVulnerabilityDetails pattern
  const fsfviScore = data.fsfvi_results?.fsfvi_score || 
                     data.system_analysis?.fsfvi_score || 0;
  const riskLevel = data.fsfvi_results?.risk_level || 
                    data.system_analysis?.risk_level || 'unknown';
  
  // Access budget the same way ComponentVulnerabilityDetails does
  const totalBudget = data.analysis_metadata?.total_budget_millions || 
                      data.financial_context?.total_budget_millions || 
                      data.system_analysis?.total_allocation_millions || 0;
  
  // Ensure totalBudget is a valid number
  const safeTotalBudget = typeof totalBudget === 'number' && !isNaN(totalBudget) ? totalBudget : 0;

  return (
    <div className="space-y-6">
      {/* Executive Summary */}
      {data.executive_summary && (
        <Card className="border-2 border-blue-200 bg-blue-50">
          <CardHeader>
            <CardTitle className="flex items-center text-blue-900">
              <Gauge className="w-5 h-5 mr-2" />
              Executive Summary
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <h3 className="font-semibold text-blue-900 mb-3">Overall Assessment</h3>
                <p className="text-blue-800 mb-4">{data.executive_summary.overall_assessment}</p>
                
                <div className="space-y-2">
                  <div className="flex justify-between">
                    <span className="text-blue-700">System Stability:</span>
                    <Badge className={getRiskColor(data.executive_summary.system_stability)}>
                      {data.executive_summary.system_stability}
                    </Badge>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-blue-700">Actions Required:</span>
                    <Badge className={data.executive_summary.immediate_actions_required ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}>
                      {data.executive_summary.immediate_actions_required ? 'Immediate' : 'Strategic'}
                    </Badge>
                  </div>
                </div>
              </div>

              <div>
                <h3 className="font-semibold text-blue-900 mb-3">Key Metrics</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div className="text-center p-3 bg-white rounded-lg">
                    <div className="text-2xl font-bold text-red-600">
                      {data.executive_summary.key_metrics.fsfvi_score}
                    </div>
                    <div className="text-xs text-gray-600">FSFVI Score</div>
                  </div>
                  <div className="text-center p-3 bg-white rounded-lg">
                    <div className="text-2xl font-bold text-green-600">
                      {data.executive_summary.key_metrics.financing_efficiency}
                    </div>
                    <div className="text-xs text-gray-600">Efficiency</div>
                  </div>
                  <div className="text-center p-3 bg-white rounded-lg">
                    <div className="text-2xl font-bold text-orange-600">
                      {data.executive_summary.key_metrics.critical_components}
                    </div>
                    <div className="text-xs text-gray-600">Critical Components</div>
                  </div>
                  <div className="text-center p-3 bg-white rounded-lg">
                    <div className="text-2xl font-bold text-blue-600">
                      {data.executive_summary.key_metrics.total_budget}
                    </div>
                    <div className="text-xs text-gray-600">Total Budget</div>
                  </div>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Core FSFVI Metrics */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <Card>
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">FSFVI Score</p>
                <p className={`text-2xl font-bold ${getVulnerabilityGaugeColor(fsfviScore)}`}>
                  {(fsfviScore * 100).toFixed(2)}%
                </p>
              </div>
              <Target className="w-8 h-8 text-blue-500" />
            </div>
            <div className="mt-2">
              <div className="w-full bg-gray-200 rounded-full h-2">
                <div 
                  className={`h-2 rounded-full ${
                    fsfviScore < 0.1 ? 'bg-green-500' :
                    fsfviScore < 0.2 ? 'bg-yellow-500' :
                    fsfviScore < 0.4 ? 'bg-orange-500' :
                    'bg-red-500'
                  }`}
                  style={{ width: `${Math.min(fsfviScore * 100, 100)}%` }}
                ></div>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Risk Level</p>
                <div className="mt-1">
                  <Badge className={getRiskColor(riskLevel)}>
                    {riskLevel.toUpperCase()}
                  </Badge>
                </div>
              </div>
              <Shield className="w-8 h-8 text-orange-500" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Financing Efficiency</p>
                <p className="text-2xl font-bold text-green-600">
                  {data.fsfvi_results?.financing_efficiency_percent?.toFixed(1) || 
                   data.system_analysis?.government_insights?.financing_efficiency_percent?.toFixed(1) || 
                   ((1 - fsfviScore) * 100).toFixed(1)}%
                </p>
              </div>
              <Activity className="w-8 h-8 text-green-500" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Total Budget</p>
                <p className="text-2xl font-bold text-blue-600">
                  ${safeTotalBudget.toFixed(1)}M
                </p>
              </div>
              <DollarSign className="w-8 h-8 text-blue-500" />
            </div>
          </CardContent>
        </Card>
      </div>

      {/* System Analysis Details */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center justify-between">
            <span className="flex items-center">
              <BarChart3 className="w-5 h-5 mr-2" />
              System Vulnerability Analysis
            </span>
            <Button variant="outline" onClick={onRefresh}>
              <RefreshCw className="w-4 h-4 mr-2" />
              Refresh
            </Button>
          </CardTitle>
          <CardDescription>
            Comprehensive analysis of food system financing vulnerability
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Component Statistics */}
            {data.system_analysis?.component_statistics && (
              <div>
                <h3 className="font-semibold text-gray-900 mb-3">Component Statistics</h3>
                <div className="space-y-3">
                  <div className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span className="text-gray-600">Average Vulnerability</span>
                    <span className="font-bold text-orange-600">
                      {(data.system_analysis.component_statistics.weighted_average_vulnerability * 100).toFixed(1)}%
                    </span>
                  </div>
                  <div className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span className="text-gray-600">Maximum Vulnerability</span>
                    <span className="font-bold text-red-600">
                      {(data.system_analysis.component_statistics.max_vulnerability * 100).toFixed(1)}%
                    </span>
                  </div>
                  <div className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span className="text-gray-600">Minimum Vulnerability</span>
                    <span className="font-bold text-green-600">
                      {(data.system_analysis.component_statistics.min_vulnerability * 100).toFixed(1)}%
                    </span>
                  </div>
                </div>
              </div>
            )}

            {/* Government Insights */}
            {data.system_analysis?.government_insights && (
              <div>
                <h3 className="font-semibold text-gray-900 mb-3">Government Insights</h3>
                <div className="space-y-3">
                  <div className="p-3 bg-blue-50 rounded-lg">
                    <div className="flex justify-between items-center">
                      <span className="text-blue-700">Resource Allocation Quality</span>
                      <Badge className="bg-blue-200 text-blue-800">
                        {data.system_analysis.government_insights.resource_allocation_quality}
                      </Badge>
                    </div>
                  </div>
                  <div className="p-3 bg-green-50 rounded-lg">
                    <div className="flex justify-between items-center">
                      <span className="text-green-700">Budget Optimization Potential</span>
                      <Badge className="bg-green-200 text-green-800">
                        {data.system_analysis.government_insights.budget_optimization_potential}
                      </Badge>
                    </div>
                  </div>
                  <div className="p-3 bg-orange-50 rounded-lg">
                    <div className="flex justify-between items-center">
                      <span className="text-orange-700">Intervention Urgency</span>
                      <Badge className="bg-orange-200 text-orange-800">
                        {data.system_analysis.government_insights.intervention_urgency}
                      </Badge>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* Critical Components Alert */}
          {data.system_analysis?.critical_components && data.system_analysis.critical_components.length > 0 && (
            <div className="mt-6 p-4 bg-red-50 border border-red-200 rounded-lg">
              <div className="flex items-start space-x-3">
                <AlertTriangle className="w-5 h-5 text-red-600 mt-0.5" />
                <div>
                  <h4 className="font-semibold text-red-900">Critical Components Requiring Immediate Action</h4>
                  <div className="mt-2 flex flex-wrap gap-2">
                    {data.system_analysis.critical_components.map((component, index) => (
                      <Badge key={index} className="bg-red-100 text-red-800">
                        {component}
                      </Badge>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Action Priorities */}
          {(data.system_analysis?.critical_components && data.system_analysis.critical_components.length > 0) && (
            <div className="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
              <h4 className="font-semibold text-yellow-900 mb-3 flex items-center">
                <Target className="w-5 h-5 mr-2" />
                Immediate Action Priorities
              </h4>
              <div className="space-y-3">
                <div className="flex items-start space-x-3">
                  <div className="flex-shrink-0 w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center text-sm font-bold">
                    1
                  </div>
                  <div className="flex-1">
                    <p className="font-medium text-yellow-900">Critical Component Intervention</p>
                    <p className="text-sm text-yellow-700">
                      Address {data.system_analysis.critical_components.length} critical components requiring immediate intervention
                    </p>
                    <div className="mt-2 flex flex-wrap gap-1">
                      {data.system_analysis.critical_components.map((comp, idx) => (
                        <Badge key={idx} className="bg-red-100 text-red-800 text-xs">{comp}</Badge>
                      ))}
                    </div>
                  </div>
                </div>

                <div className="flex items-start space-x-3">
                  <div className="flex-shrink-0 w-8 h-8 bg-orange-500 text-white rounded-full flex items-center justify-center text-sm font-bold">
                    2
                  </div>
                  <div className="flex-1">
                    <p className="font-medium text-yellow-900">Budget Reallocation</p>
                    <p className="text-sm text-yellow-700">
                      Optimize resource allocation with {data.financial_context?.optimization_potential} potential for improvement
                    </p>
                  </div>
                </div>

                <div className="flex items-start space-x-3">
                  <div className="flex-shrink-0 w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold">
                    3
                  </div>
                  <div className="flex-1">
                    <p className="font-medium text-yellow-900">System Monitoring</p>
                    <p className="text-sm text-yellow-700">
                      Implement enhanced monitoring for components with vulnerability range of {data.system_analysis?.component_statistics?.vulnerability_range ? (data.system_analysis.component_statistics.vulnerability_range * 100).toFixed(1) : 'N/A'}%
                    </p>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Performance Benchmark Analysis */}
          {data.system_analysis?.component_statistics && (
            <div className="mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
              <h4 className="font-semibold text-green-900 mb-3 flex items-center">
                <BarChart3 className="w-5 h-5 mr-2" />
                Performance Benchmark Analysis
              </h4>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="text-center p-3 bg-white rounded-lg border">
                  <div className="text-2xl font-bold text-green-600">
                    {((1 - data.system_analysis.component_statistics.weighted_average_vulnerability) * 100).toFixed(1)}%
                  </div>
                  <div className="text-sm text-green-700">System Resilience</div>
                  <div className="text-xs text-green-600 mt-1">Above 70% = Strong</div>
                </div>
                <div className="text-center p-3 bg-white rounded-lg border">
                  <div className="text-2xl font-bold text-blue-600">
                    {data.system_analysis.component_statistics.total_components || 0}
                  </div>
                  <div className="text-sm text-blue-700">Components Analyzed</div>
                  <div className="text-xs text-blue-600 mt-1">Comprehensive Coverage</div>
                </div>
                <div className="text-center p-3 bg-white rounded-lg border">
                  <div className="text-2xl font-bold text-purple-600">
                    {data.weighting_method?.toUpperCase() || 'HYBRID'}
                  </div>
                  <div className="text-sm text-purple-700">Analysis Method</div>
                  <div className="text-xs text-purple-600 mt-1">Advanced Weighting</div>
                </div>
              </div>
            </div>
          )}


        </CardContent>
      </Card>
    </div>
  );
}; 